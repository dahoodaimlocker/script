-- LocalScript, place this in StarterPlayerScripts or a LocalScript in StarterGui

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

local espEnabled = false
local aimlockEnabled = false
local currentTarget = nil
local espObjects = {}

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "ESP_Aimlock_GUI"

local ToggleESPButton = Instance.new("TextButton", ScreenGui)
ToggleESPButton.Size = UDim2.new(0, 100, 0, 40)
ToggleESPButton.Position = UDim2.new(0, 10, 0, 10)
ToggleESPButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ToggleESPButton.TextColor3 = Color3.new(1, 1, 1)
ToggleESPButton.Text = "ESP: OFF"
ToggleESPButton.Font = Enum.Font.GothamBold
ToggleESPButton.TextSize = 14
ToggleESPButton.BorderSizePixel = 0
ToggleESPButton.BackgroundTransparency = 0.2
ToggleESPButton.AutoButtonColor = true
ToggleESPButton.ZIndex = 2

-- ESP Function
local function toggleESP()
    espEnabled = not espEnabled
    ToggleESPButton.Text = "ESP: " .. (espEnabled and "ON" or "OFF")
    
    for _, v in pairs(espObjects) do
        if v and v.Adornee then
            v:Destroy()
        end
    end
    table.clear(espObjects)
end

ToggleESPButton.MouseButton1Click:Connect(toggleESP)

-- Create ESP box
local function createESP(player)
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end

    local box = Instance.new("BillboardGui")
    box.Name = "ESPBox"
    box.Adornee = character:WaitForChild("HumanoidRootPart")
    box.Size = UDim2.new(4, 0, 5, 0)
    box.AlwaysOnTop = true

    local frame = Instance.new("Frame", box)
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Color3.new(1, 0, 0)
    frame.BackgroundTransparency = 0.4
    frame.BorderSizePixel = 0

    box.Parent = game.CoreGui
    table.insert(espObjects, box)
end

-- Update ESP
RunService.RenderStepped:Connect(function()
    if espEnabled then
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= localPlayer and not espObjects[player] then
                if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                    createESP(player)
                end
            end
        end
    end
end)

-- Aimlock Functionality
local function getClosestPlayerToMouse()
    local target = nil
    local shortest = math.huge
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local head = player.Character.Head
            local pos, onScreen = camera:WorldToViewportPoint(head.Position)
            if onScreen then
                local mousePos = UserInputService:GetMouseLocation()
                local dist = (Vector2.new(pos.X, pos.Y) - Vector2.new(mousePos.X, mousePos.Y)).Magnitude
                if dist < shortest then
                    shortest = dist
                    target = player
                end
            end
        end
    end
    return target
end

-- Lock aim to target
RunService.RenderStepped:Connect(function()
    if aimlockEnabled and currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("Head") then
        camera.CFrame = CFrame.new(camera.CFrame.Position, currentTarget.Character.Head.Position)
    end
end)

-- Toggle aimlock with Q key
UserInputService.InputBegan:Connect(function(input, isTyping)
    if isTyping then return end
    if input.KeyCode == Enum.KeyCode.Q then
        if aimlockEnabled then
            aimlockEnabled = false
            currentTarget = nil
        else
            currentTarget = getClosestPlayerToMouse()
            aimlockEnabled = currentTarget ~= nil
        end
    end
end)
