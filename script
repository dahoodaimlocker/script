-- LocalScript, place in StarterPlayerScripts or StarterGui

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

local espEnabled = false
local aimlockEnabled = false
local currentTarget = nil
local espObjects = {}

-- GUI Setup
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "ESP_Aimlock_GUI"

local ToggleESPButton = Instance.new("TextButton", ScreenGui)
ToggleESPButton.Size = UDim2.new(0, 100, 0, 40)
ToggleESPButton.Position = UDim2.new(0, 10, 0, 10)
ToggleESPButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ToggleESPButton.TextColor3 = Color3.new(1, 1, 1)
ToggleESPButton.Text = "ESP: OFF"
ToggleESPButton.Font = Enum.Font.GothamBold
ToggleESPButton.TextSize = 14
ToggleESPButton.BorderSizePixel = 0
ToggleESPButton.BackgroundTransparency = 0.2
ToggleESPButton.AutoButtonColor = true
ToggleESPButton.ZIndex = 2

-- Toggle ESP On/Off
local function toggleESP()
	espEnabled = not espEnabled
	ToggleESPButton.Text = "ESP: " .. (espEnabled and "ON" or "OFF")
	
	for _, v in pairs(espObjects) do
		if v then v:Destroy() end
	end
	table.clear(espObjects)
end

ToggleESPButton.MouseButton1Click:Connect(toggleESP)

-- Create Outline ESP Box
local function createESP(player)
	if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
	if player.Team == localPlayer.Team then return end

	local box = Instance.new("BillboardGui")
	box.Name = "ESPBox"
	box.Adornee = player.Character.HumanoidRootPart
	box.Size = UDim2.new(4, 0, 5, 0)
	box.AlwaysOnTop = true
	box.ResetOnSpawn = false

	local frame = Instance.new("Frame", box)
	frame.Name = "Outline"
	frame.Size = UDim2.new(1, 0, 1, 0)
	frame.BackgroundTransparency = 1 -- No fill
	frame.BorderSizePixel = 2
	frame.BorderColor3 = Color3.new(1, 0, 0) -- Default red

	box.Parent = game.CoreGui
	espObjects[player] = box
end

-- Update ESP
RunService.RenderStepped:Connect(function()
	if espEnabled then
		for _, player in pairs(Players:GetPlayers()) do
			if player ~= localPlayer and player.Team ~= localPlayer.Team then
				if player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Humanoid") then
					if not espObjects[player] then
						createESP(player)
					end
					local gui = espObjects[player]
					local health = player.Character.Humanoid.Health
					local maxHealth = player.Character.Humanoid.MaxHealth
					local percent = math.clamp(health / maxHealth, 0, 1)
					if gui and gui:FindFirstChild("Outline") then
						gui.Outline.BorderColor3 = Color3.fromRGB(255 * (1 - percent), 255 * percent, 0)
					end
				end
			elseif espObjects[player] then
				espObjects[player]:Destroy()
				espObjects[player] = nil
			end
		end
	else
		for _, box in pairs(espObjects) do
			if box then box:Destroy() end
		end
		table.clear(espObjects)
	end
end)

-- Get Closest Player to Mouse
local function getClosestPlayerToMouse()
	local closestPlayer = nil
	local shortestDistance = math.huge
	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= localPlayer and player.Character and player.Character:FindFirstChild("Head") then
			local head = player.Character.Head
			local screenPos, onScreen = camera:WorldToViewportPoint(head.Position)
			if onScreen then
				local mousePos = UserInputService:GetMouseLocation()
				local distance = (Vector2.new(screenPos.X, screenPos.Y) - Vector2.new(mousePos.X, mousePos.Y)).Magnitude
				if distance < shortestDistance then
					shortestDistance = distance
					closestPlayer = player
				end
			end
		end
	end
	return closestPlayer
end

-- Lock Aim to Head
RunService.RenderStepped:Connect(function()
	if aimlockEnabled and currentTarget and currentTarget.Character and currentTarget.Character:FindFirstChild("Head") then
		camera.CFrame = CFrame.new(camera.CFrame.Position, currentTarget.Character.Head.Position)
	end
end)

-- Toggle Aimlock with Q
UserInputService.InputBegan:Connect(function(input, isTyping)
	if isTyping then return end
	if input.KeyCode == Enum.KeyCode.Q then
		if aimlockEnabled then
			aimlockEnabled = false
			currentTarget = nil
		else
			currentTarget = getClosestPlayerToMouse()
			aimlockEnabled = currentTarget ~= nil
		end
	end
end)
